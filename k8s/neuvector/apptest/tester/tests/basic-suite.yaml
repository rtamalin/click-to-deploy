actions:

- name: Try to get IP of NeuVector service
  bashTest:
    script: |
      timeout 120 bash -c '
        until (host "${APP_SERVICE}" | grep "has address");
          do sleep 2;
        done'
    expect:
      exitCode:
        equals: 0

- name: Try to connect to NeuVector service
  bashTest:
    script: |
      # TODO: inject controller address via env var
      timeout 120 bash -c '
        until curl -k -H "Connection: close" "https://neuvector-svc-controller.neuvector:10443/v1/eula"
          do sleep 2;
        done'
    expect:
      exitCode:
        equals: 0

- name: Positive authentication to NeuVector web console with correct credentials
  bashTest:
    script: |-
      wget --user "${NEUVECTOR_ADMIN_USER}" \
        --password "${NEUVECTOR_ADMIN_PASSWORD}" \
        "http://${APP_SERVICE}:8443/admin" -O /dev/null
    expect:
      stderr:
        contains: 'HTTP request sent, awaiting response... 200 OK'
      exitCode:
        equals: 0

- name: Failed authentication to NeuVector web console with wrong credentials
  bashTest:
    script: |-
      wget --user "${NEUVECTOR_ADMIN_USER}" \
        --password "some-other-passwd" \
        "http://${APP_SERVICE}:8443/admin" -O /dev/null
    expect:
      stderr:
        contains: 'Username/Password Authentication Failed.'
      exitCode:
        equals: 6
